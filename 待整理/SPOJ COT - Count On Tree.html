<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600986 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <meta name="application-data:2525275" content="10389191/s94/594325fd-fc40-4b60-b758-62d9005ab50d/www.evernote.com"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="504"/>

<div>
<span><div><a href="http://www.spoj.com/problems/COT/">http://www.spoj.com/problems/COT/</a><br/></div><div><br/></div><div><a href="http://blog.csdn.net/qq_33184171/article/details/61631979">http://blog.csdn.net/qq_33184171/article/details/61631979</a><br/></div><div><a href="https://github.com/anudeep2011/programming/blob/master/COT.cpp">https://github.com/anudeep2011/programming/blob/master/COT.cpp</a><br/></div><div><a href="https://blog.anudeep2011.com/persistent-segment-trees-explained-with-spoj-problems/">https://blog.anudeep2011.com/persistent-segment-trees-explained-with-spoj-problems/</a><br/></div><div><br/></div><div><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// Persistent Segment Tree, </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">主席树</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">题意：有一棵</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">N</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">个节点的树</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">(N &lt;= 1e5)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">，每个节点有值</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">Ai</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">，</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">Ai</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">可重复出现。</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">Q</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">个请求，</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">f(u, v, k)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">求</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">u-&gt;v</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">路径上第</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">k</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">小的数字</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">思路：首先对</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">A</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">进行压缩得到</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">B</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">，因为</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">Ai</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">可重复，所以</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00"> BN = sizeof(B) &lt;= sizeof(A)</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">在</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">[0...BN)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">区间建立线段树，这个线段树记录当前已经出现的位序（比如第</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">K</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">大的数字已经出现，则</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">Bk = 1)</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">树上每个节点分配一个上述线段树，按照</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">DFS</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">先序遍历树，每到一个节点时，</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">“</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">拷贝父节点的线段树</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">”</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">后将</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">Ai</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">的对应位序更新到该线段树上，作为本节点线段树</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">根据如上规则，节点</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">u</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">的线段树只会记录</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">u</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">到</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">root</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">路径上的位序。在这个线段树上求</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00"> &lt;= X</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">位序的数字个数，就是求</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">root-&gt;u</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">路径上</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00"> &lt;= X</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">位序的数字个数</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">设</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">g(u, X)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">是</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">root-&gt;u</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">路径上</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00"> &lt;= X</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">位序的数字个数，</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">G(u, v, X)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">是</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">u-&gt;v</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">路径上</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00"> &lt;= X</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">位序的数字个数</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// G(u, v, X) = g(u, X) + g(v, X) - g(lca(u, v), X) - g(parent(lca(u, v)), X), </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">画个图比较容易</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">get</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">到</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">于是我们可以用二分法确定一个最小的</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">X</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">，使</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">G(u, v, X) &gt;= k</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">，</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">X</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">就是</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">u-&gt;v</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">路径上第</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">k</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">小的位序</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">数据结构：</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// 1. </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">每个节点上都有一棵线段树，并且和父节点的线段树只有一个</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">count</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">之差，用</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">Persistent Segment Tree</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">进行处理</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// 2. lca(u, v)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">使用</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">ST</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">表</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">O(NlogN)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">初始化后，</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">O(1)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">时间查询</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">优化：</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">目前的初始化复杂度</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00"> O(NlogN)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">，查询</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00"> O(M * logN * logN)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">，查询部分可以优化</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">上述出现的</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">4</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">个</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">g(u, X)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">，</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">g(v, X), g(lca(u, v), X), g(parent(lca(u, v)), X)</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">分别对应</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">u, v, lca(u, v), parent(lca(u, v))</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">点上的线段树，所有线段树的规模都是完全相同，如果我们将这</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">4</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">个线段树合并，得到就是一棵只有</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">u-&gt;v</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">路径上位序的线段树！在这棵线段树上可以直接求第</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">k</span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">小的数字，时间复杂度</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">O(logN)</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000"><br/>
</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">// </span><span style="font: 11.0px 'PingFang SC'; font-variant-ligatures: no-common-ligatures; color: #008f00">优化后时间复杂度是</span><span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #008f00">&lt;O(NlogN), O(MlogN)&gt;</span></div><div><br/></div><div><a href="SPOJ COT - Count On Tree_files/SPOJ_COT.cpp"><img src="SPOJ COT - Count On Tree_files/6ee054bc92133db545cdb22df3293ffe.png" alt="SPOJ_COT.cpp"></a><br/></div><div><br/></div><div>Persistent Segment Tree小结</div><div>PST在版本管理机制上非常精妙，每次只用了logN的空间和时间就增加了一个版本，与ACD的mutable异曲同工。线段树合并的思路更是让人拍案叫绝。在一维数组上，每个线段树记录了从0位置开始的位序计数；在树状结构上，每个线段树记录了从根节点开始的位序计数。合并后可以得到的则是一个能描述“中间断”计数的线段树。这种行为很像是sum[j] - sum[i-1]得到[i,j]区间的sum。</div><div><br/></div></span>
</div></body></html> 